<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/node_modules/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="/node_modules/codemirror/addon/lint/lint.css">
    <link rel="stylesheet" href="/node_modules/codemirror/addon/hint/show-hint.css">
    <link rel="stylesheet" href="/node_modules/codemirror/addon/fold/foldgutter.css">
    <link rel="stylesheet" href="/node_modules/codemirror-addon-lint-fix/dist/lint-fix.css">
    <link rel="stylesheet" href="/node_modules/codemirror-addon-infotip/dist/infotip.css">
    <link rel="stylesheet" href="/node_modules/mirrorsharp/mirrorsharp.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
    <link rel="stylesheet" href="/static/style/style.css">
    <link rel="stylesheet" href="/static/style/code.css">
    <link rel="stylesheet" href="/static/style/misc.css">
    <link rel="stylesheet" href="/static/xterm_master/xterm.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Poiret+One&amp;subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Cormorant:400&amp;subset=cyrillic" rel="stylesheet"> 
    <title>Test</title>
</head>

<body style="height: 100%; width: 100%;">
    <script src="/socket.io/socket.io.js"></script>

    <div class="window task-window">
        <div class="window-frame"></div>
        <div class="window-content">
            <div class="task-container">
                <div class="left-split-panel">
                    <div class="upper-split-panel">
                        <div>
                            <div id="run_button" class="noselect">
                                <span>Запуск</span>
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div>
                            <textarea id="code" style="width:100%; height: 100%;">{{ startup }}</textarea>
                        </div>
                    </div>
                    <div class="vertical-splitter">
                        <span></span>
                    </div>
                    <div class="bottom-split-panel">
                        <div>
                            <div id="term"></div>
                        </div>
                    </div>
                </div>
                <div class="horizontal-splitter">
                    <span></span>
                </div>
                <div class="right-split-panel">
                    <div>
                        <div class="md-container">{{ definition }}</div>
                        <div class="buttons-container">
                            <div id="confirm_button">Проверить</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="message_box" style="visibility: collapse; position: absolute; z-index: 1000; background-color: white; top: 50%; left: 50%; width: 400px; height: 200px; margin-top: -100px; margin-left: -200px;">
                <div style="height: 80%; box-sizing: border-box; padding: 10px 20px;">
                    <div id="message_content" style="height: 100%; width: 100%; word-wrap: break-word; border: 1px solid black; border-radius: 5px;"></div>
                </div>
                <div style="height: 20%;">
                    <button id="message_button">OK</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
    <script src="/node_modules/codemirror/lib/codemirror.js"></script>
    <script src="/node_modules/codemirror/mode/clike/clike.js"></script>
    <script src="/node_modules/codemirror/mode/mllike/mllike.js"></script>
    <script src="/node_modules/codemirror/addon/lint/lint.js"></script>
    <script src="/node_modules/codemirror/addon/hint/show-hint.js"></script>
    <script src="/node_modules/codemirror-addon-lint-fix/dist/lint-fix.js"></script>
    <script src="/node_modules/codemirror-addon-infotip/dist/infotip.js"></script>
    <script src="/node_modules/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="/node_modules/codemirror/addon/edit/closebrackets.js"></script>
    <script src="/node_modules/codemirror/addon/selection/active-line.js"></script>
    <script src="/node_modules/mirrorsharp/mirrorsharp.js"></script>
    <script src="/static/xterm_master/xterm.js"></script>
    <script src="/static/xterm_master/fit.js"></script>
    <script src="/static/code.js"></script>
    <script type="text/javascript">
        let run_button = document.getElementById("run_button");
        let confirm_button = document.getElementById("confirm_button");
        let output = document.getElementById("console");
        let code = document.getElementById("code");
        let definition = document.querySelector(".md-container");

        let message_box = document.getElementById("message_box");
        let message = document.getElementById("message_content");
        let message_button = document.getElementById("message_button");

        let socket = io.connect("/test", {
            reconnection: false
        });

        CodeMirror.defaults.autofocus = true;
        const mirror = mirrorsharp(code, {
            serviceUrl: "ws://sharp.eu-west-1.elasticbeanstalk.com/mirrorsharp",
            selfDebugEnabled: true,
            language: "C#"
        });

        let codemirror = mirror.getCodeMirror();
        codemirror.setOption("matchBrackets", true);
        codemirror.setOption("autoCloseBrackets", true);
        codemirror.setOption("lineNumbers", true);
        codemirror.setOption("styleActiveLine", true);
        let sourceCodeDoc = codemirror.getDoc();

        let markdownConverter = new showdown.Converter();
        let htmlMd = markdownConverter.makeHtml(definition.innerHTML);
        definition.innerHTML = htmlMd;

        let isRunning = false;

        run_button.addEventListener("click", function () {

            if (!isRunning) {

                socket.emit("run", {
                    sourceCode: sourceCodeDoc.getValue()
                });
                run_button.children[0].innerHTML = "Stop";
                run_button.children[1].classList.remove("fa-play");
                run_button.children[1].classList.add("fa-stop");

            } else {

                socket.emit("stop");
                run_button.children[0].innerHTML = "Run";
                run_button.children[1].classList.remove("fa-stop");
                run_button.children[1].classList.add("fa-play");

            }
            isRunning = !isRunning;

        });

        socket.on("end", () => {

            isRunning = false;
            run_button.children[0].innerHTML = "Run";
            run_button.children[1].classList.remove("fa-stop");
            run_button.children[1].classList.add("fa-play");

        });

        // input_button.addEventListener("click", function () {

        //     socket.emit("input", {
        //         input: input.value
        //     });
        //     input.value = "";

        // });

        socket.on("output", function (data) {

            let span = document.createElement("span");
            span.style.whiteSpace = "pre-wrap";
            span.innerHTML = data.output;
            output.appendChild(span);

        });

        confirm_button.addEventListener("click", function () {

            socket.emit("test", {
                sourceCode: sourceCodeDoc.getValue()
            });

        });

        socket.on("result", function (data) {

            if (data.status == "failed") {
                message.innerHTML = "Неудача!\n" + data.results;
                message_button.innerHTML = "Попробовать снова";

            } else {
                message.innerHTML = "Всё правильно!";
                message_button.innerHTML = "Вперёд!";
            }
            message_box.style.visibility = "visible";
        });

        message_button.addEventListener("click", function () {

            message_box.style.visibility = "collapse";

        });
    </script>
</body>

</html>